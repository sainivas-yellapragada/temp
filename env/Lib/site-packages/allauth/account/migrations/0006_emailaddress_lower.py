from django.conf import settings
from django.db import migrations
from allauth.account import app_settings


def forwards(apps, schema_editor):
    # Get models
    EmailAddress = apps.get_model("account", "EmailAddress")
    User = apps.get_model(settings.AUTH_USER_MODEL)
    
    # Update EmailAddress table to make all emails lowercase
    for email_address in EmailAddress.objects.all():
        lower_email = email_address.email.lower()
        if email_address.email != lower_email:
            email_address.email = lower_email
            email_address.save()
    
    # Update User table to make email field (if any) lowercase
    email_field = app_settings.USER_MODEL_EMAIL_FIELD
    if email_field:
        for user in User.objects.all():
            user_email = getattr(user, email_field, None)
            if user_email:
                lower_user_email = user_email.lower()
                if user_email != lower_user_email:
                    setattr(user, email_field, lower_user_email)
                    user.save()


class Migration(migrations.Migration):
    dependencies = [
        ("account", "0005_emailaddress_idx_upper_email"),
    ]

    operations = [migrations.RunPython(forwards)]
